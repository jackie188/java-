## 实时数仓数据可视化接口实现

### 数据可视化接口

之前数据分层处理，最后把轻度聚合的结果保存到 ClickHouse 中，主要的目的就是提供**即时**的数据查询、统计、分析服务。这些统计服务一般会用两种形式展现，一种是为专业的数据分析人员的 BI 工具，一种是面向非专业人员的更加直观的数据大屏。

以下主要是面向百度的 sugar 的数据大屏服务的接口开发。

### 需求梳理

![1638599103560](https://tprzfbucket.oss-cn-beijing.aliyuncs.com/hadoop/202112/04/142505-997584.png)

数据可视化一共八个需求

**商品主题表中四个需求：**

1. 总的成交金额
2. 品牌分组交易额，按照trademark统计
3. 品类分组交易额，按照category统计
4. 商品spu分组交易额，按照商品spu

**地区主题表**

1. 省市分组金额

**用户访问分析**

1. uv分时统计

2. pv分时统计量

3. 新用户分时数量

**新老用户对比**

1. uv计数

2. pv计数

3. 跳出率

4. 访问时长

5. 访问人数

在可视化大屏中每个组件都需要一个单独的接口，图中一共涉及 8 个组件，对于每一个组件，最后一列表示数据的来源。

![1638599183705](https://tprzfbucket.oss-cn-beijing.aliyuncs.com/hadoop/202112/04/142624-97497.png)

接口的执行过程

![1638599230513](https://tprzfbucket.oss-cn-beijing.aliyuncs.com/hadoop/202112/04/142711-700498.png)

之前我们实现了 DWS 层计算后写入到 ClickHouse 中，接下来就是要为可视化大屏服务，提供一个数据接口用来查询 ClickHouse 中的数据。这里主要有两项工作：

1. 配置可视化大屏服务。
2. 编写数据查询接口以供可视化大屏进行访问。

### Sugar使用

1. 选取所需要的数据展示的格式。

2. 拉去的数据格式：

~~~ java
{
"status": 0,
"msg": "",
"data": 1201081.1632389291
}
~~~

也就是我们使用Flink sql查询到的结果，需要封装为这种json格式传出去。

3. 写数据接口，其实就是使用sql查询然后传输给Sugar接口去展示。